<!--
 - Created by ern on 26/05/20.
 -->
<apex:page >
    <apex:includeScript value="/support/console/46.0/integration.js"/>

    <script type="text/javascript">
      sforce.console.addEventListener(sforce.console.ConsoleEvent.PRESENCE.WORK_ACCEPTED, function(result) {
          console.log('*** engagedChats: ', result);
        // Get Engaged Chats for Agent
        sforce.console.chat.getEngagedChats(function(result) {
          console.log('*** engagedChats: ', result);
          if (result.success === true && Array.isArray(result.chatKey) && result.chatKey.length > 0) {
            for (var i = 0; i < result.chatKey.length; i++) {
              var chatKey = result.chatKey[i];

              // Send initial message with Phone Number
              /*var phone = undefined;
              sforce.console.chat.getDetailsByChatKey(chatKey, function(result) {
                //Report whether accepting the chat was succesful
                if (result.success === true) {
                  var customDetails = result.details.customDetails;
                  console.log('*** Custom Details: ', customDetails);
                  if (Array.isArray(customDetails) && customDetails.length > 0) {
                    customDetails.forEach(function(detail) {
                      if (detail.label === 'Phone') {
                        phone = detail.value;
                        if (phone) {
                          sforce.console.chat.sendMessage(chatKey, 'Contact Phone: ' + phone);
                          return;
                        }
                      }
                    });
                  }
                }
              });*/

              /*Monitors every chat message sent by the agent to verify that the chat has not been transferred.*/
              sforce.console.chat.onAgentSend(chatKey, function(resOnAgentSend) {
                console.log('*** resOnAgentSend.isAutoGreeting: ' + resOnAgentSend.isAutoGreeting);
                console.log('*** resOnAgentSend.isTransferred: ' + resOnAgentSend.isTransferred);
                console.log('*** resOnAgentSend.content: ' + resOnAgentSend.content);

                if (!(resOnAgentSend.isAutoGreeting && resOnAgentSend.isTransferred)) {
                  sforce.console.chat.sendMessage(chatKey, resOnAgentSend.content);
                } else {
                  /*Sends your customized transfer message to the customer if the chat has been transferred to a new agent.*/
                  sforce.console.chat.sendMessage(chatKey, "Hi! Thank you for your patience. Give me one second while I review your chat.");
                }
              });
            }
          }
        });
      });
    </script>

</apex:page>