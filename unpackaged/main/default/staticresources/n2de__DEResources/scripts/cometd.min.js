/*
 * Copyright (c) 2008-2020 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
!function(e,t){"object"==typeof exports?module.exports=t():"function"==typeof define&&define.amd?define([],t):(e.org=e.org||{},e.org.cometd=t())}(this,function(){var e=function(){var e=0,t={};this.register=function(n){var i=++e;return t[i]=n,i},this.unregister=function(e){var n=t[e];return delete t[e],n},this.setTimeout=function(e,t){return window.setTimeout(e,t)},this.clearTimeout=function(e){window.clearTimeout(e)}};var t={isString:function(e){return null!=e&&("string"==typeof e||e instanceof String)},isArray:function(e){return null!=e&&e instanceof Array},inArray:function(e,t){for(var n=0;n<t.length;++n)if(e===t[n])return n;return-1}},n=function(){var e=[],t={};this.getTransportTypes=function(){return e.slice(0)},this.findTransportTypes=function(n,i,r){for(var o=[],s=0;s<e.length;++s){var a=e[s];!0===t[a].accept(n,i,r)&&o.push(a)}return o},this.negotiateTransport=function(n,i,r,o){for(var s=0;s<e.length;++s)for(var a=e[s],c=0;c<n.length;++c)if(a===n[c]){var u=t[a];if(!0===u.accept(i,r,o))return u}return null},this.add=function(n,i,r){for(var o=!1,s=0;s<e.length;++s)if(e[s]===n){o=!0;break}return o||("number"!=typeof r?e.push(n):e.splice(r,0,n),t[n]=i),!o},this.find=function(n){for(var i=0;i<e.length;++i)if(e[i]===n)return t[n];return null},this.remove=function(n){for(var i=0;i<e.length;++i)if(e[i]===n){e.splice(i,1);var r=t[n];return delete t[n],r}return null},this.clear=function(){e=[],t={}},this.reset=function(n){for(var i=0;i<e.length;++i)t[e[i]].reset(n)}},i=function(){var e,n,i;this.registered=function(t,i){e=t,n=i},this.unregistered=function(){e=null,n=null},this._debug=function(){n._debug.apply(n,arguments)},this._mixin=function(){return n._mixin.apply(n,arguments)},this.getConfiguration=function(){return n.getConfiguration()},this.getAdvice=function(){return n.getAdvice()},this.setTimeout=function(e,t){return n.setTimeout(e,t)},this.clearTimeout=function(e){n.clearTimeout(e)},this.convertToMessages=function(e){if(t.isString(e))try{return JSON.parse(e)}catch(t){throw this._debug("Could not convert to JSON the following string",'"'+e+'"'),t}if(t.isArray(e))return e;if(null==e)return[];if(e instanceof Object)return[e];throw"Conversion Error "+e+", typeof "+typeof e},this.accept=function(e,t,n){throw"Abstract"},this.getType=function(){return e},this.getURL=function(){return i},this.setURL=function(e){i=e},this.send=function(e,t){throw"Abstract"},this.reset=function(t){this._debug("Transport",e,"reset",t?"initial":"retry")},this.abort=function(){this._debug("Transport",e,"aborted")},this.toString=function(){return this.getType()}};i.derive=function(e){function t(){}return t.prototype=e,new t};var r=function(){var e=new i,n=i.derive(e),r=0,o=null,s=[],a=[];function c(e,t){if(this.transportSend(e,t),t.expired=!1,!e.sync){var n=this.getConfiguration().maxNetworkDelay,i=n;!0===t.metaConnect&&(i+=this.getAdvice().timeout),this._debug("Transport",this.getType(),"waiting at most",i,"ms for the response, maxNetworkDelay",n);var r=this;t.timeout=this.setTimeout(function(){t.expired=!0;var n="Request "+t.id+" of transport "+r.getType()+" exceeded "+i+" ms max network delay",o={reason:n},s=t.xhr;o.httpCode=r.xhrStatus(s),r.abortXHR(s),r._debug(n),r.complete(t,!1,t.metaConnect),e.onFailure(s,e.messages,o)},i)}}function u(e){var t=++r,n={id:t,metaConnect:!1,envelope:e};s.length<this.getConfiguration().maxConnections-1?(s.push(n),c.call(this,e,n)):(this._debug("Transport",this.getType(),"queueing request",t,"envelope",e),a.push([e,n]))}function l(e,n){var i=t.inArray(e,s);if(i>=0&&s.splice(i,1),a.length>0){var r=a.shift(),o=r[0],c=r[1];if(this._debug("Transport dequeued request",c.id),n)this.getConfiguration().autoBatch&&function(e){for(;a.length>0;){var t=a[0],n=t[0],i=t[1];if(n.url!==e.url||n.sync!==e.sync)break;a.shift(),e.messages=e.messages.concat(n.messages),this._debug("Coalesced",n.messages.length,"messages from request",i.id)}}.call(this,o),u.call(this,o),this._debug("Transport completed request",e.id,o);else{var l=this;this.setTimeout(function(){l.complete(c,!1,c.metaConnect);var e={reason:"Previous request failed"},t=c.xhr;e.httpCode=l.xhrStatus(t),o.onFailure(t,o.messages,e)},0)}}}return n.complete=function(e,t,n){n?function(e){var t=e.id;if(this._debug("Transport",this.getType(),"/meta/connect complete, request",t),null!==o&&o.id!==t)throw"/meta/connect request mismatch, completing request "+t;o=null}.call(this,e):l.call(this,e,t)},n.transportSend=function(e,t){throw"Abstract"},n.transportSuccess=function(e,t,n){t.expired||(this.clearTimeout(t.timeout),this.complete(t,!0,t.metaConnect),n&&n.length>0?e.onSuccess(n):e.onFailure(t.xhr,e.messages,{httpCode:204}))},n.transportFailure=function(e,t,n){t.expired||(this.clearTimeout(t.timeout),this.complete(t,!1,t.metaConnect),e.onFailure(t.xhr,e.messages,n))},n.send=function(e,t){t?function(e){if(null!==o)throw"Concurrent /meta/connect requests not allowed, request id="+o.id+" not yet completed";var t=++r;this._debug("Transport",this.getType(),"/meta/connect send, request",t,"envelope",e);var n={id:t,metaConnect:!0,envelope:e};c.call(this,e,n),o=n}.call(this,e):u.call(this,e)},n.abort=function(){e.abort();for(var t=0;t<s.length;++t){var n=s[t];n&&(this._debug("Aborting request",n),this.abortXHR(n.xhr)||this.transportFailure(n.envelope,n,{reason:"abort"}))}var i=o;i&&(this._debug("Aborting /meta/connect request",i),this.abortXHR(i.xhr)||this.transportFailure(i.envelope,i,{reason:"abort"})),this.reset(!0)},n.reset=function(t){e.reset(t),o=null,s=[],a=[]},n.abortXHR=function(e){if(e)try{var t=e.readyState;return e.abort(),t!==window.XMLHttpRequest.UNSENT}catch(e){this._debug(e)}return!1},n.xhrStatus=function(e){if(e)try{return e.status}catch(e){this._debug(e)}return-1},n},o=function(){var e=new r,t=i.derive(e),n=!0;return t.accept=function(e,t,i){return n||!t},t.newXMLHttpRequest=function(){return new window.XMLHttpRequest},t.xhrSend=function(e){var n=t.newXMLHttpRequest();!function(e){try{e.context=t.context}catch(e){this._debug("Could not copy transport context into XHR",e)}}(n),n.withCredentials=!0,n.open("POST",e.url,!0!==e.sync);var i=e.headers;if(i)for(var r in i)i.hasOwnProperty(r)&&n.setRequestHeader(r,i[r]);return n.setRequestHeader("Content-Type","application/json;charset=UTF-8"),n.onload=function(){200===n.status?e.onSuccess(n.responseText):e.onError(n.statusText)},n.onabort=n.onerror=function(){e.onError(n.statusText)},n.send(e.body),n},t.transportSend=function(e,t){this._debug("Transport",this.getType(),"sending request",t.id,"envelope",e);var i=this;try{var r=!0;t.xhr=this.xhrSend({transport:this,url:e.url,sync:e.sync,headers:this.getConfiguration().requestHeaders,body:JSON.stringify(e.messages),onSuccess:function(r){i._debug("Transport",i.getType(),"received response",r);var o=!1;try{var s=i.convertToMessages(r);0===s.length?(n=!1,i.transportFailure(e,t,{httpCode:204})):(o=!0,i.transportSuccess(e,t,s))}catch(r){if(i._debug(r),!o){n=!1;var a={exception:r};a.httpCode=i.xhrStatus(t.xhr),i.transportFailure(e,t,a)}}},onError:function(o,s){i._debug("Transport",i.getType(),"received error",o,s),n=!1;var a={reason:o,exception:s};a.httpCode=i.xhrStatus(t.xhr),r?i.setTimeout(function(){i.transportFailure(e,t,a)},0):i.transportFailure(e,t,a)}}),r=!1}catch(r){n=!1,this.setTimeout(function(){i.transportFailure(e,t,{exception:r})},0)}},t.reset=function(t){e.reset(t),n=!0},t},s=function(){var e=new r,t=i.derive(e),n=0;function o(e,t,n){var i=this;return function(){i.transportFailure(e,t,"error",n)}}return t.accept=function(e,t,n){return!0},t.jsonpSend=function(e){var t=document.getElementsByTagName("head")[0],i=document.createElement("script"),r="_cometd_jsonp_"+n++;window[r]=function(n){t.removeChild(i),delete window[r],e.onSuccess(n)};var o=e.url;o+=o.indexOf("?")<0?"?":"&",o+="jsonp="+r,o+="&message="+encodeURIComponent(e.body),i.src=o,i.async=!0!==e.sync,i.type="application/javascript",i.onerror=function(t){e.onError("jsonp "+t.type)},t.appendChild(i)},t.transportSend=function(e,t){for(var n=this,i=0,r=e.messages.length,s=[];r>0;){var a=JSON.stringify(e.messages.slice(i,i+r)),c=e.url.length+encodeURI(a).length,u=this.getConfiguration().maxURILength;if(c>u){if(1===r){var l="Bayeux message too big ("+c+" bytes, max is "+u+") for transport "+this.getType();return void this.setTimeout(o.call(this,e,t,l),0)}--r}else s.push(r),i+=r,r=e.messages.length-i}var f=e;if(s.length>1){var h=0,d=s[0];this._debug("Transport",this.getType(),"split",e.messages.length,"messages into",s.join(" + ")),(f=this._mixin(!1,{},e)).messages=e.messages.slice(h,d),f.onSuccess=e.onSuccess,f.onFailure=e.onFailure;for(var g=1;g<s.length;++g){var p=this._mixin(!1,{},e);h=d,d+=s[g],p.messages=e.messages.slice(h,d),p.onSuccess=e.onSuccess,p.onFailure=e.onFailure,this.send(p,t.metaConnect)}}this._debug("Transport",this.getType(),"sending request",t.id,"envelope",f);try{var m=!0;this.jsonpSend({transport:this,url:f.url,sync:f.sync,headers:this.getConfiguration().requestHeaders,body:JSON.stringify(f.messages),onSuccess:function(e){var i=!1;try{var r=n.convertToMessages(e);0===r.length?n.transportFailure(f,t,{httpCode:204}):(i=!0,n.transportSuccess(f,t,r))}catch(e){n._debug(e),i||n.transportFailure(f,t,{exception:e})}},onError:function(e,i){var r={reason:e,exception:i};m?n.setTimeout(function(){n.transportFailure(f,t,r)},0):n.transportFailure(f,t,r)}}),m=!1}catch(e){this.setTimeout(function(){n.transportFailure(f,t,{exception:e})},0)}},t},a=function(){var e,n=new i,r=i.derive(n),o=!0,s=!1,a=!0,c=null,u=null,l=!1,f=null;function h(e,t){e&&(this.webSocketClose(e,t.code,t.reason),this.onClose(e,t))}function d(e){return e===u||e===c}function g(e,t,n){for(var i=[],r=0;r<t.messages.length;++r){var o=t.messages[r];o.id&&i.push(o.id)}e.envelopes[i.join(",")]=[t,n],this._debug("Transport",this.getType(),"stored envelope, envelopes",e.envelopes)}function p(t,n,i){var r=JSON.stringify(n.messages);t.webSocket.send(r),this._debug("Transport",this.getType(),"sent",n,"/meta/connect =",i);var o=this.getConfiguration().maxNetworkDelay,s=o;i&&(s+=this.getAdvice().timeout,l=!0);for(var a=this,c=[],u=0;u<n.messages.length;++u)!function(){var i=n.messages[u];i.id&&(c.push(i.id),t.timeouts[i.id]=a.setTimeout(function(){e._debug("Transport",a.getType(),"timing out message",i.id,"after",s,"on",t),h.call(a,t,{code:1e3,reason:"Message Timeout"})},s))}();this._debug("Transport",this.getType(),"waiting at most",s,"ms for messages",c,"maxNetworkDelay",o,", timeouts:",t.timeouts)}function m(t,n,i){try{null===t?(t=u||{envelopes:{},timeouts:{}},g.call(this,t,n,i),function(t){if(!u){var n=e.getURL().replace(/^http/,"ws");this._debug("Transport",this.getType(),"connecting to URL",n);try{var i=e.getConfiguration().protocol;t.webSocket=i?new window.WebSocket(n,i):new window.WebSocket(n),u=t}catch(e){throw o=!1,this._debug("Exception while creating WebSocket object",e),e}a=!1!==e.getConfiguration().stickyReconnect;var r=this,l=e.getConfiguration().connectTimeout;l>0&&(t.connectTimer=this.setTimeout(function(){e._debug("Transport",r.getType(),"timed out while connecting to URL",n,":",l,"ms"),h.call(r,t,{code:1e3,reason:"Connect Timeout"})},l));var f=function(n){n=n||{code:1e3},e._debug("WebSocket onclose",t,n,"connecting",u,"current",c),t.connectTimer&&r.clearTimeout(t.connectTimer),r.onClose(t,n)};t.webSocket.onopen=function(){e._debug("WebSocket onopen",t),t.connectTimer&&r.clearTimeout(t.connectTimer),d(t)?(u=null,c=t,s=!0,r.onOpen(t)):(e._warn("Closing extra WebSocket connection",this,"active connection",c),h.call(r,t,{code:1e3,reason:"Extra Connection"}))},t.webSocket.onclose=f,t.webSocket.onerror=function(){f({code:1e3,reason:"Error"})},t.webSocket.onmessage=function(n){e._debug("WebSocket onmessage",n,t),r.onMessage(t,n)},this._debug("Transport",this.getType(),"configured callbacks on",t)}}.call(this,t)):(g.call(this,t,n,i),p.call(this,t,n,i))}catch(e){var r=this;this.setTimeout(function(){h.call(r,t,{code:1e3,reason:"Exception",exception:e})},0)}}return r.reset=function(e){n.reset(e),o=!0,e&&(s=!1),a=!0,c=null,u=null,l=!1},r._notifySuccess=function(e,t){e.call(this,t)},r._notifyFailure=function(e,t,n,i){e.call(this,t,n,i)},r.onOpen=function(e){var t=e.envelopes;for(var n in this._debug("Transport",this.getType(),"opened",e,"pending messages",t),t)if(t.hasOwnProperty(n)){var i=t[n],r=i[0],o=i[1];f=r.onSuccess,p.call(this,e,r,o)}},r.onMessage=function(e,n){this._debug("Transport",this.getType(),"received websocket message",n,e);for(var i=!1,r=this.convertToMessages(n.data),o=[],s=0;s<r.length;++s){var a=r[s];if((/^\/meta\//.test(a.channel)||void 0===a.data)&&a.id){o.push(a.id);var c=e.timeouts[a.id];c&&(this.clearTimeout(c),delete e.timeouts[a.id],this._debug("Transport",this.getType(),"removed timeout for message",a.id,", timeouts",e.timeouts))}"/meta/connect"===a.channel&&(l=!1),"/meta/disconnect"!==a.channel||l||(i=!0)}for(var u=!1,h=e.envelopes,d=0;d<o.length;++d){var g=o[d];for(var p in h)if(h.hasOwnProperty(p)){var m=p.split(","),v=t.inArray(g,m);if(v>=0){u=!0,m.splice(v,1);var b=h[p][0],y=h[p][1];delete h[p],m.length>0&&(h[m.join(",")]=[b,y]);break}}}u&&this._debug("Transport",this.getType(),"removed envelope, envelopes",h),this._notifySuccess(f,r),i&&this.webSocketClose(e,1e3,"Disconnect")},r.onClose=function(e,t){this._debug("Transport",this.getType(),"closed",e,t),d(e)&&(o=a&&s,u=null,c=null);var n=e.timeouts;for(var i in e.timeouts={},n)n.hasOwnProperty(i)&&this.clearTimeout(n[i]);var r=e.envelopes;for(var f in e.envelopes={},r)if(r.hasOwnProperty(f)){var h=r[f][0];r[f][1]&&(l=!1);var g={websocketCode:t.code,reason:t.reason};t.exception&&(g.exception=t.exception),this._notifyFailure(h.onFailure,e,h.messages,g)}},r.registered=function(t,i){n.registered(t,i),e=i},r.accept=function(t,n,i){return this._debug("Transport",this.getType(),"accept, supported:",o),o&&!!window.WebSocket&&!1!==e.websocketEnabled},r.send=function(e,t){this._debug("Transport",this.getType(),"sending",e,"/meta/connect =",t),m.call(this,c,e,t)},r.webSocketClose=function(e,t,n){try{e.webSocket&&e.webSocket.close(t,n)}catch(e){this._debug(e)}},r.abort=function(){n.abort(),h.call(this,c,{code:1e3,reason:"Abort"}),this.reset(!0)},r},c=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z",".","-",":","+","=","^","!","/","*","?","&","<",">","(",")","[","]","{","}","@","%","$","#"],u=[0,68,0,84,83,82,72,0,75,76,70,65,0,63,62,69,0,1,2,3,4,5,6,7,8,9,64,0,73,66,74,71,81,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,77,0,78,67,0,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,79,0,80,0,0];return{CometD:function(i){var r,c,u,l,f,h=new e,d=this,g=i||"default",p=!1,m=new n,v="disconnected",b=0,y=null,T=0,w=[],x=!1,k=0,_={},C=0,S=null,R=[],I={},L={},U={},q=!1,E=!1,A=0,B=0,F=null,M={useWorkerScheduler:!0,protocol:null,stickyReconnect:!0,connectTimeout:0,maxConnections:2,backoffIncrement:1e3,maxBackoff:6e4,logLevel:"info",maxNetworkDelay:1e4,requestHeaders:{},appendMessageTypeToURL:!0,autoBatch:!1,urls:{},maxURILength:2e3,advice:{timeout:6e4,interval:0,reconnect:void 0,maxInterval:0}};function O(e,t){try{return e[t]}catch(e){return}}function P(e){return t.isString(e)}function D(e){return null!=e&&"function"==typeof e}function N(e,t){for(var n="";--t>0&&!(e>=Math.pow(10,t));)n+="0";return n+=e}function j(e,t){if(window.console){var n=window.console[e];if(D(n)){var i=new Date;[].splice.call(t,0,0,N(i.getHours(),2)+":"+N(i.getMinutes(),2)+":"+N(i.getSeconds(),2)+"."+N(i.getMilliseconds(),3)),n.apply(window.console,t)}}}function H(e){return new RegExp("(^https?://)?(((\\[[^\\]]+])|([^:/?#]+))(:(\\d+))?)?([^?#]*)(.*)?").exec(e)}function W(e){d._debug("Configuring cometd object with",e),P(e)&&(e={url:e}),e||(e={}),M=d._mixin(!1,M,e);var t=d.getURL();if(!t)throw"Missing required configuration parameter 'url' specifying the Bayeux server URL";var n=H(t),i=n[2],r=n[8],o=n[9];if(p=d._isCrossDomain(i),M.appendMessageTypeToURL)if(void 0!==o&&o.length>0)d._info("Appending message type to URI "+r+o+" is not supported, disabling 'appendMessageTypeToURL' configuration"),M.appendMessageTypeToURL=!1;else{var s=r.split("/"),a=s.length-1;r.match(/\/$/)&&(a-=1),s[a].indexOf(".")>=0&&(d._info("Appending message type to URI "+r+" is not supported, disabling 'appendMessageTypeToURL' configuration"),M.appendMessageTypeToURL=!1)}if(window.Worker&&window.Blob&&window.URL&&M.useWorkerScheduler){var c=function(){var e={};self.onmessage=function(t){var n=t.data,i=e[n.id];switch(n.type){case"setTimeout":e[n.id]=self.setTimeout(function(){delete e[n.id],self.postMessage({id:n.id})},n.delay);break;case"clearTimeout":delete e[n.id],i&&self.clearTimeout(i);break;default:throw"Unknown command "+n.type}}}.toString();c=c.substring(c.indexOf("{")+1,c.lastIndexOf("}"));var u=new window.Blob([c],{type:"application/json"}),l=window.URL.createObjectURL(u),f=new window.Worker(l);h.setTimeout=function(e,t){var n=h.register(e);return f.postMessage({id:n,type:"setTimeout",delay:t}),n},h.clearTimeout=function(e){h.unregister(e),f.postMessage({id:e,type:"clearTimeout"})},f.onmessage=function(e){var t=e.data.id,n=h.unregister(t);n&&n()}}}function X(e){if(e){var t=_[e.channel];t&&t[e.id]&&(delete t[e.id],d._debug("Removed",e.listener?"listener":"subscription",e))}}function J(e){e&&!e.listener&&X(e)}function V(){for(var e in _)if(_.hasOwnProperty(e)){var t=_[e];if(t)for(var n in t)t.hasOwnProperty(n)&&J(t[n])}}function z(e){v!==e&&(d._debug("Status",v,"->",e),v=e)}function Z(){return"disconnecting"===v||"disconnected"===v}function $(){return""+ ++b}function G(e,t,n,i,r){try{return t.call(e,i)}catch(e){var o=d.onExtensionException;if(D(o)){d._debug("Invoking extension exception handler",n,e);try{o.call(d,e,n,r,i)}catch(e){d._info("Exception during execution of extension exception handler",n,e)}}else d._info("Exception during execution of extension",n,e);return i}}function K(e){for(var t=R.length-1;t>=0&&null!=e;--t){var n=R[t],i=n.extension.outgoing;if(D(i)){var r=G(n.extension,i,n.name,e,!0);e=void 0===r?e:r}}return e}function Q(e,t){var n=_[e];if(n)for(var i in n)if(n.hasOwnProperty(i)){var r=n[i];if(r)try{r.callback.call(r.scope,t)}catch(e){var o=d.onListenerException;if(D(o)){d._debug("Invoking listener exception handler",r,e);try{o.call(d,e,r,r.listener,t)}catch(e){d._info("Exception during execution of listener exception handler",r,e)}}else d._info("Exception during execution of listener",r,t,e)}}}function Y(e,t){Q(e,t);for(var n=e.split("/"),i=n.length-1,r=i;r>0;--r){var o=n.slice(0,r).join("/")+"/*";r===i&&Q(o,t),Q(o+="*",t)}}function ee(){null!==S&&d.clearTimeout(S),S=null}function te(e,t){ee();var n=I.interval+t;d._debug("Function scheduled in",n,"ms, interval =",I.interval,"backoff =",C,e),S=d.setTimeout(e,n)}function ne(e,t,n){for(var i=0;i<e.length;++i){var o=e[i],s=o.id;y&&(o.clientId=y),null!=(o=K(o))?(o.id=s,e[i]=o):(delete L[s],e.splice(i--,1))}if(0!==e.length){t&&(F=e[0]);var a=d.getURL();M.appendMessageTypeToURL&&(a.match(/\/$/)||(a+="/"),n&&(a+=n));var c={url:a,sync:!1,messages:e,onSuccess:function(e){try{l.call(d,e)}catch(e){d._info("Exception during handling of messages",e)}},onFailure:function(e,t,n){try{var i=d.getTransport();n.connectionType=i?i.getType():"unknown",f.call(d,e,t,n)}catch(e){d._info("Exception during handling of failure",e)}}};d._debug("Send",c),r.send(c,t)}}function ie(e){T>0||!0===x?w.push(e):ne([e],!1)}function re(){C=0}function oe(){var e=w;w=[],e.length>0&&ne(e,!1)}function se(e){z("connecting"),te(function(){!function(){if(!Z()){var e={id:$(),channel:"/meta/connect",connectionType:r.getType()};E||(e.advice={timeout:0}),z("connecting"),d._debug("Connect sent",e),ne([e],!0,"connect"),z("connected")}}()},e)}function ae(e){e&&(I=d._mixin(!1,{},M.advice,e),d._debug("New advice",I))}function ce(e){if(ee(),e&&r&&r.abort(),p=!1,r=null,z("disconnected"),y=null,T=0,re(),q=!1,E=!1,A=0,F=null,w.length>0){var t=w;w=[],f.call(d,void 0,t,{reason:"Disconnected"})}}function ue(e,t,n){var i=d.onTransportException;if(D(i)){d._debug("Invoking transport exception handler",e,t,n);try{i.call(d,n,e,t)}catch(e){d._info("Exception during execution of transport exception handler",e)}}}function le(e,t){D(e)&&(t=e,e=void 0),y=null,V(),Z()&&m.reset(!0),ae({}),T=0,x=!0,c=e,u=t;var n=d.getURL(),i=m.findTransportTypes("1.0",p,n),o={id:$(),version:"1.0",minimumVersion:"1.0",channel:"/meta/handshake",supportedConnectionTypes:i,advice:{timeout:I.timeout,interval:I.interval}},s=d._mixin(!1,{},c,o);if(d._putCallback(s.id,t),!r&&!(r=m.negotiateTransport(i,"1.0",p,n))){var a="Could not find initial transport among: "+m.getTransportTypes();throw d._warn(a),a}d._debug("Initial transport is",r.getType()),z("handshaking"),d._debug("Handshake sent",s),ne([s],!1,"handshake")}function fe(e,t){try{e.call(d,t)}catch(e){var n=d.onCallbackException;if(D(n)){d._debug("Invoking callback exception handler",e);try{n.call(d,e,t)}catch(e){d._info("Exception during execution of callback exception handler",e)}}else d._info("Exception during execution of message callback",e)}}function he(e){var t=d._getCallback([e.id]);D(t)&&(delete L[e.id],fe(t,e))}function de(e){var t=U[e.id];if(delete U[e.id],t){d._debug("Handling remote call response for",e,"with context",t);var n=t.timeout;n&&d.clearTimeout(n);var i=t.callback;if(D(i))return fe(i,e),!0}return!1}function ge(e){d._debug("Transport failure handling",e),e.transport&&(r=e.transport),e.url&&r.setURL(e.url);var t=e.action,n=e.delay||0;switch(t){case"handshake":!function(e){z("handshaking"),x=!0,te(function(){le(c,u)},e)}(n);break;case"retry":se(n);break;case"none":ce(!0);break;default:throw"Unknown action "+t}}function pe(e,t){he(e),Y("/meta/handshake",e),Y("/meta/unsuccessful",e),Z()&&(t.action="none"),d.onTransportFailure.call(d,e,t,ge)}function me(e){pe(e,{cause:"failure",action:"handshake",transport:null})}function ve(e){return"disconnected"===v||!(!F||F.id!==e.id)&&(F=null,!0)}function be(e,t){Y("/meta/connect",e),Y("/meta/unsuccessful",e),Z()&&(t.action="none"),d.onTransportFailure.call(d,e,t,ge)}function ye(e){ve(e)?(E=!1,be(e,{cause:"failure",action:"retry",transport:null})):d._debug("Mismatched /meta/connect failure",e)}function Te(e){ce(!0),he(e),Y("/meta/disconnect",e),Y("/meta/unsuccessful",e)}function we(e){Te(e)}function xe(e){var t=_[e.subscription];if(t)for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];i&&!i.listener&&(delete t[n],d._debug("Removed failed subscription",i))}he(e),Y("/meta/subscribe",e),Y("/meta/unsuccessful",e)}function ke(e){xe(e)}function _e(e){he(e),Y("/meta/unsubscribe",e),Y("/meta/unsuccessful",e)}function Ce(e){_e(e)}function Se(e){de(e)||(he(e),Y("/meta/publish",e),Y("/meta/unsuccessful",e))}function Re(e){Se(e)}function Ie(e){if(A=0,null!=(e=function(e){for(var t=0;t<R.length&&null!=e;++t){var n=R[t],i=n.extension.incoming;if(D(i)){var r=G(n.extension,i,n.name,e,!1);e=void 0===r?e:r}}return e}(e)))switch(ae(e.advice),e.channel){case"/meta/handshake":!function(e){var t=d.getURL();if(e.successful){var n=d._isCrossDomain(H(t)[2]),i=m.negotiateTransport(e.supportedConnectionTypes,e.version,n,t);if(null===i)return e.successful=!1,void pe(e,{cause:"negotiation",action:"none",transport:null});r!==i&&(d._debug("Transport",r.getType(),"->",i.getType()),r=i),y=e.clientId,x=!1,oe(),e.reestablish=q,q=!0,he(e),Y("/meta/handshake",e),B=e["x-messages"]||0;var o=Z()?"none":I.reconnect||"retry";switch(o){case"retry":re(),0===B?se(0):d._debug("Processing",B,"handshake-delivered messages");break;case"none":ce(!0);break;default:throw"Unrecognized advice action "+o}}else pe(e,{cause:"unsuccessful",action:I.reconnect||"handshake",transport:r})}(e);break;case"/meta/connect":!function(e){if(ve(e))if(E=e.successful){Y("/meta/connect",e);var t=Z()?"none":I.reconnect||"retry";switch(t){case"retry":re(),se(C);break;case"none":ce(!1);break;default:throw"Unrecognized advice action "+t}}else be(e,{cause:"unsuccessful",action:I.reconnect||"retry",transport:r});else d._debug("Mismatched /meta/connect reply",e)}(e);break;case"/meta/disconnect":!function(e){e.successful?(ce(!1),he(e),Y("/meta/disconnect",e)):Te(e)}(e);break;case"/meta/subscribe":!function(e){e.successful?(he(e),Y("/meta/subscribe",e)):xe(e)}(e);break;case"/meta/unsubscribe":!function(e){e.successful?(he(e),Y("/meta/unsubscribe",e)):_e(e)}(e);break;default:!function(e){void 0!==e.data?de(e)||(Y(e.channel,e),B>0&&0==--B&&(d._debug("Processed last handshake-delivered message"),se(0))):void 0===e.successful?d._warn("Unknown Bayeux Message",e):e.successful?(he(e),Y("/meta/publish",e)):Se(e)}(e)}}function Le(e){var t=_[e];if(t)for(var n in t)if(t.hasOwnProperty(n)&&t[n])return!0;return!1}function Ue(e,t){var n={scope:e,method:t};if(D(e))n.scope=void 0,n.method=e;else if(P(t)){if(!e)throw"Invalid scope "+e;if(n.method=e[t],!D(n.method))throw"Invalid callback "+t+" for scope "+e}else if(!D(t))throw"Invalid callback "+t;return n}function qe(e,t,n,i){var r=Ue(t,n);d._debug("Adding",i?"listener":"subscription","on",e,"with scope",r.scope,"and callback",r.method);var o=++k,s={id:o,channel:e,scope:r.scope,callback:r.method,listener:i},a=_[e];return a||(a={},_[e]=a),a[o]=s,d._debug("Added",i?"listener":"subscription",s),s}this._mixin=function(e,t,n){for(var i=t||{},r=2;r<arguments.length;++r){var o=arguments[r];if(null!=o)for(var s in o)if(o.hasOwnProperty(s)){var a=O(o,s),c=O(i,s);if(a===t)continue;if(void 0===a)continue;if(e&&"object"==typeof a&&null!==a)if(a instanceof Array)i[s]=this._mixin(e,c instanceof Array?c:[],a);else{var u="object"!=typeof c||c instanceof Array?{}:c;i[s]=this._mixin(e,u,a)}else i[s]=a}}return i},this._warn=function(){j("warn",arguments)},this._info=function(){"warn"!==M.logLevel&&j("info",arguments)},this._debug=function(){"debug"===M.logLevel&&j("debug",arguments)},this._isCrossDomain=function(e){return!!(window.location&&window.location.host&&e)&&e!==window.location.host},this.send=ie,this._getCallback=function(e){return L[e]},this._putCallback=function(e,t){var n=this._getCallback(e);return D(t)&&(L[e]=t),n},this.onTransportFailure=function(e,t,n){this._debug("Transport failure",t,"for",e);var i=this.getTransportRegistry(),o=this.getURL(),s=this._isCrossDomain(H(o)[2]),a=i.findTransportTypes("1.0",s,o);if("none"===t.action){if("/meta/handshake"===e.channel&&!t.transport){var c="Could not negotiate transport, client=["+a+"], server=["+e.supportedConnectionTypes+"]";this._warn(c),ue(r.getType(),null,{reason:c,connectionType:r.getType(),transport:r})}}else if(t.delay=this.getBackoffPeriod(),"/meta/handshake"===e.channel){if(!t.transport){var u=r?r.getType():null,l=i.negotiateTransport(a,"1.0",s,o);if(l){var f=l.getType();this._debug("Transport",u,"->",f),ue(u,f,e.failure),t.action="handshake",t.transport=l}else this._warn("Could not negotiate transport, client=["+a+"]"),ue(u,null,e.failure),t.action="none"}"none"!==t.action&&this.increaseBackoffPeriod()}else{var h=(new Date).getTime();if(0===A&&(A=h),"retry"===t.action){t.delay=this.increaseBackoffPeriod();var g=I.maxInterval;if(g>0){var p=I.timeout+I.interval+g;h-A+C>p&&(t.action="handshake")}}"handshake"===t.action&&(t.delay=0,i.reset(!1),this.resetBackoffPeriod())}n.call(d,t)},this.receive=Ie,l=function(e){d._debug("Received",e);for(var t=0;t<e.length;++t)Ie(e[t])},f=function(e,t,n){d._debug("handleFailure",e,t,n),n.transport=e;for(var i=0;i<t.length;++i){var r=t[i],o={id:r.id,successful:!1,channel:r.channel,failure:n};switch(n.message=r,r.channel){case"/meta/handshake":me(o);break;case"/meta/connect":ye(o);break;case"/meta/disconnect":we(o);break;case"/meta/subscribe":o.subscription=r.subscription,ke(o);break;case"/meta/unsubscribe":o.subscription=r.subscription,Ce(o);break;default:Re(o)}}},this.registerTransport=function(e,t,n){var i=m.add(e,t,n);return i&&(this._debug("Registered transport",e),D(t.registered)&&t.registered(e,this)),i},this.unregisterTransport=function(e){var t=m.remove(e);return null!==t&&(this._debug("Unregistered transport",e),D(t.unregistered)&&t.unregistered()),t},this.unregisterTransports=function(){m.clear()},this.getTransportTypes=function(){return m.getTransportTypes()},this.findTransport=function(e){return m.find(e)},this.getTransportRegistry=function(){return m},this.configure=function(e){W.call(this,e)},this.init=function(e,t){this.configure(e),this.handshake(t)},this.handshake=function(e,t){if("disconnected"!==v)throw"Illegal state: handshaken";le(e,t)},this.disconnect=function(e,t){if(!Z()){D(e)&&(t=e,e=void 0);var n={id:$(),channel:"/meta/disconnect"},i=this._mixin(!1,{},e,n);d._putCallback(i.id,t),z("disconnecting"),ne([i],!1,"disconnect")}},this.startBatch=function(){++T,d._debug("Starting batch, depth",T)},this.endBatch=function(){!function(){if(--T,d._debug("Ending batch, depth",T),T<0)throw"Calls to startBatch() and endBatch() are not paired";0!==T||Z()||x||oe()}()},this.batch=function(e,t){var n=Ue(e,t);this.startBatch();try{n.method.call(n.scope),this.endBatch()}catch(e){throw this._info("Exception during execution of batch",e),this.endBatch(),e}},this.addListener=function(e,t,n){if(arguments.length<2)throw"Illegal arguments number: required 2, got "+arguments.length;if(!P(e))throw"Illegal argument type: channel must be a string";return qe(e,t,n,!0)},this.removeListener=function(e){if(!(e&&e.channel&&"id"in e))throw"Invalid argument: expected subscription, not "+e;X(e)},this.clearListeners=function(){_={}},this.subscribe=function(e,t,n,i,r){if(arguments.length<2)throw"Illegal arguments number: required 2, got "+arguments.length;if(!P(e))throw"Illegal argument type: channel must be a string";if(Z())throw"Illegal state: disconnected";D(t)&&(r=i,i=n,n=t,t=void 0),D(i)&&(r=i,i=void 0);var o=!Le(e),s=qe(e,t,n,!1);if(o){var a={id:$(),channel:"/meta/subscribe",subscription:e},c=this._mixin(!1,{},i,a);d._putCallback(c.id,r),ie(c)}return s},this.unsubscribe=function(e,t,n){if(arguments.length<1)throw"Illegal arguments number: required 1, got "+arguments.length;if(Z())throw"Illegal state: disconnected";D(t)&&(n=t,t=void 0),this.removeListener(e);var i=e.channel;if(!Le(i)){var r={id:$(),channel:"/meta/unsubscribe",subscription:i},o=this._mixin(!1,{},t,r);d._putCallback(o.id,n),ie(o)}},this.resubscribe=function(e,t){if(J(e),e)return this.subscribe(e.channel,e.scope,e.callback,t)},this.clearSubscriptions=function(){V()},this.publish=function(e,t,n,i){if(arguments.length<1)throw"Illegal arguments number: required 1, got "+arguments.length;if(!P(e))throw"Illegal argument type: channel must be a string";if(/^\/meta\//.test(e))throw"Illegal argument: cannot publish to meta channels";if(Z())throw"Illegal state: disconnected";D(t)?(i=t,t={},n=void 0):D(n)&&(i=n,n=void 0);var r={id:$(),channel:e,data:t},o=this._mixin(!1,{},n,r);d._putCallback(o.id,i),ie(o)},this.publishBinary=function(e,t,n,i,r){D(t)?(r=t,t=new ArrayBuffer(0),n=!0,i=void 0):D(n)?(r=n,n=!0,i=void 0):D(i)&&(r=i,i=void 0);var o={meta:i,data:t,last:n};this.publish(e,o,{ext:{binary:{}}},r)},this.remoteCall=function(e,t,n,i,r){if(arguments.length<1)throw"Illegal arguments number: required 1, got "+arguments.length;if(!P(e))throw"Illegal argument type: target must be a string";if(Z())throw"Illegal state: disconnected";if(D(t)?(r=t,t={},n=M.maxNetworkDelay,i=void 0):D(n)?(r=n,n=M.maxNetworkDelay,i=void 0):D(i)&&(r=i,i=void 0),"number"!=typeof n)throw"Illegal argument type: timeout must be a number";e.match(/^\//)||(e="/"+e);var o="/service"+e,s={id:$(),channel:o,data:t},a=this._mixin(!1,{},i,s),c={callback:r};n>0&&(c.timeout=d.setTimeout(function(){d._debug("Timing out remote call",a,"after",n,"ms"),Se({id:a.id,error:"406::timeout",successful:!1,failure:{message:a,reason:"Remote Call Timeout"}})},n),d._debug("Scheduled remote call timeout",a,"in",n,"ms")),U[a.id]=c,ie(a)},this.remoteCallBinary=function(e,t,n,i,r,o){D(t)?(o=t,t=new ArrayBuffer(0),n=!0,i=void 0,r=M.maxNetworkDelay):D(n)?(o=n,n=!0,i=void 0,r=M.maxNetworkDelay):D(i)?(o=i,i=void 0,r=M.maxNetworkDelay):D(r)&&(o=r,r=M.maxNetworkDelay);var s={meta:i,data:t,last:n};this.remoteCall(e,s,r,{ext:{binary:{}}},o)},this.getStatus=function(){return v},this.isDisconnected=Z,this.setBackoffIncrement=function(e){M.backoffIncrement=e},this.getBackoffIncrement=function(){return M.backoffIncrement},this.getBackoffPeriod=function(){return C},this.increaseBackoffPeriod=function(){return C<M.maxBackoff&&(C+=M.backoffIncrement),C},this.resetBackoffPeriod=function(){re()},this.setLogLevel=function(e){M.logLevel=e},this.registerExtension=function(e,t){if(arguments.length<2)throw"Illegal arguments number: required 2, got "+arguments.length;if(!P(e))throw"Illegal argument type: extension name must be a string";for(var n=!1,i=0;i<R.length;++i)if(R[i].name===e){n=!0;break}return n?(this._info("Could not register extension with name",e,"since another extension with the same name already exists"),!1):(R.push({name:e,extension:t}),this._debug("Registered extension",e),D(t.registered)&&t.registered(e,this),!0)},this.unregisterExtension=function(e){if(!P(e))throw"Illegal argument type: extension name must be a string";for(var t=!1,n=0;n<R.length;++n){var i=R[n];if(i.name===e){R.splice(n,1),t=!0,this._debug("Unregistered extension",e);var r=i.extension;D(r.unregistered)&&r.unregistered();break}}return t},this.getExtension=function(e){for(var t=0;t<R.length;++t){var n=R[t];if(n.name===e)return n.extension}return null},this.getName=function(){return g},this.getClientId=function(){return y},this.getURL=function(){if(r){var e=r.getURL();if(e)return e;if(e=M.urls[r.getType()])return e}return M.url},this.getTransport=function(){return r},this.getConfiguration=function(){return this._mixin(!0,{},M)},this.getAdvice=function(){return this._mixin(!0,{},I)},this.setTimeout=function(e,t){return h.setTimeout(function(){try{d._debug("Invoking timed function",e),e()}catch(t){d._debug("Exception invoking timed function",e,t)}},t)},this.clearTimeout=function(e){h.clearTimeout(e)},window.WebSocket&&this.registerTransport("websocket",new a),this.registerTransport("long-polling",new o),this.registerTransport("callback-polling",new s)},Transport:i,RequestTransport:r,LongPollingTransport:o,CallbackPollingTransport:s,WebSocketTransport:a,Utils:t,Z85:{encode:function(e){var t=null;if(e instanceof ArrayBuffer?t=e:e.buffer instanceof ArrayBuffer?t=e.buffer:Array.isArray(e)&&(t=new Uint8Array(e).buffer),null==t)throw"Cannot Z85 encode "+e;for(var n=t.byteLength,i=n%4,r=4-(0===i?4:i),o=new DataView(t),s="",a=0,u=0;u<n+r;++u){var l=u>=n;if(a=256*a+(l?0:o.getUint8(u)),(u+1)%4==0){for(var f=52200625,h=5;h>0;--h){if(!l||h>r){var d=Math.floor(a/f)%85;s+=c[d]}f/=85}a=0}}return s},decode:function(e){for(var t=e.length%5,n=5-(0===t?5:t),i=0;i<n;++i)e+=c[c.length-1];for(var r=e.length,o=new ArrayBuffer(4*r/5-n),s=new DataView(o),a=0,l=0,f=0,h=0;h<r;++h){var d=e.charCodeAt(l++)-32;if(a=85*a+u[d],l%5==0){for(var g=16777216;g>=1;)f<s.byteLength&&s.setUint8(f++,Math.floor(a/g)%256),g/=256;a=0}}return o}}}});